(()=>{var e={};e.id=175,e.ids=[175],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2908:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>g,serverHooks:()=>c,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>u});var o={};r.r(o),r.d(o,{POST:()=>l});var n=r(6559),s=r(8088),i=r(7719),a=r(2190);class p{static generateImagePrompt(e,t,r){let o=this.buildBaseCharacterPrompt(e),n=this.analyzeEmotion(t),s=this.analyzeScenario(t,r),i=this.analyzeAction(t),a=this.analyzeDetailedExpression(t);return{prompt:this.buildEnhancedPrompt(o,n,s,i,a),negativePrompt:this.buildNegativePrompt(),emotion:n.name,scenario:s.name}}static buildBaseCharacterPrompt(e){let t=e.character_definition?.appearance;if(!t)return`beautiful anime girl, ${e.name}`;let r=[];return t.description&&r.push(t.description),t.hair&&r.push(t.hair),t.eyes&&r.push(t.eyes),t.clothing&&r.push(t.clothing),r.join(", ")}static analyzeEmotion(e){for(let t of[{keywords:["嬉しい","楽しい","笑","うふふ","わーい","最高","やったー","\uD83D\uDE0A","\uD83D\uDE04","\uD83C\uDF89"],name:"喜び",prompt:"happy expression, bright smile, sparkling eyes, cheerful"},{keywords:["怒","イライラ","ムカつく","プンプン","許せない","\uD83D\uDCA2","\uD83D\uDE20","\uD83D\uDE21"],name:"怒り",prompt:"angry expression, frowning, furrowed brows, clenched fists"},{keywords:["悲しい","泣","うるうる","しょんぼり","寂しい","\uD83D\uDE22","\uD83D\uDE2D","\uD83D\uDE14"],name:"悲しみ",prompt:"sad expression, teary eyes, downcast look, melancholic"},{keywords:["恥ずかし","照れ","もじもじ","ドキドキ","赤面","\uD83D\uDE33","\uD83D\uDE0A","\uD83D\uDC95"],name:"恥ずかしさ",prompt:"blushing, shy expression, embarrassed, looking away"},{keywords:["驚","びっくり","えっ","まじで","うそ","\uD83D\uDE32","\uD83D\uDE31","\uD83E\uDD14"],name:"驚き",prompt:"surprised expression, wide eyes, open mouth, shocked"},{keywords:["困","悩","うーん","どうしよう","迷","\uD83D\uDE05","\uD83D\uDE30","\uD83E\uDD37"],name:"困惑",prompt:"confused expression, troubled look, thinking pose"},{keywords:["愛","好き","ラブ","ドキ","胸きゅん","\uD83D\uDC95","❤️","\uD83D\uDE0D"],name:"愛情",prompt:"loving expression, gentle smile, warm eyes, affectionate"}])if(t.keywords.some(t=>e.includes(t)))return t;return{name:"自然",prompt:"natural expression, gentle look, calm"}}static analyzeScenario(e,t){let r=t?[...t,e].join(" "):e;for(let e of[{keywords:["お風呂","シャワー","入浴","温泉","バスタオル"],name:"バスルーム",prompt:"bathroom setting, steam, water droplets, towel"},{keywords:["ベッド","寝室","布団","枕","寝る","眠い"],name:"ベッドルーム",prompt:"bedroom setting, bed, pillows, soft lighting"},{keywords:["キッチン","料理","食事","ご飯","コーヒー"],name:"キッチン",prompt:"kitchen setting, cooking, food preparation"},{keywords:["外","散歩","公園","街","外出","買い物"],name:"屋外",prompt:"outdoor setting, natural lighting, scenery background"},{keywords:["学校","教室","勉強","宿題","制服"],name:"学校",prompt:"school setting, classroom, desk, school uniform"},{keywords:["海","ビーチ","水着","泳","夏"],name:"ビーチ",prompt:"beach setting, ocean background, summer, swimwear"},{keywords:["夜","暗い","月","星","ライト"],name:"夜",prompt:"night setting, dark atmosphere, moonlight, soft lighting"}])if(e.keywords.some(e=>r.includes(e)))return e;return{name:"室内",prompt:"indoor setting, room background, soft lighting"}}static analyzeAction(e){for(let t of[{keywords:["手を振","挨拶","おはよう","こんにちは","こんばんは"],name:"挨拶",prompt:"waving hand, greeting gesture, friendly pose"},{keywords:["食べ","飲み","お茶","コーヒー","食事"],name:"食事",prompt:"eating, drinking, holding cup, dining"},{keywords:["歩","走","移動","向かう"],name:"移動",prompt:"walking, running, dynamic pose, movement"},{keywords:["考え","悩み","うーん","思考"],name:"思考",prompt:"thinking pose, hand on chin, contemplating"},{keywords:["笑","微笑","にこ","くすくす"],name:"笑顔",prompt:"smiling, laughing, cheerful expression"},{keywords:["見","眺め","観察","じっと"],name:"観察",prompt:"looking, gazing, observing, focused attention"},{keywords:["座","椅子","ソファ"],name:"座る",prompt:"sitting, seated pose, relaxed posture"},{keywords:["立","起立","まっすぐ"],name:"立つ",prompt:"standing, upright posture, confident stance"}])if(t.keywords.some(t=>e.includes(t)))return t;return{name:"自然",prompt:"natural pose, casual stance"}}static analyzeDetailedExpression(e){for(let t of[{keywords:["ウィンク","ぱちり","片目"],name:"ウィンク",prompt:"winking, one eye closed, playful expression"},{keywords:["頷","うん","そうだね"],name:"頷き",prompt:"nodding, agreeing gesture, understanding look"},{keywords:["首をかしげ","？","はて","疑問"],name:"首かしげ",prompt:"tilting head, questioning look, curious expression"},{keywords:["指差","あっち","そっち","こっち"],name:"指差し",prompt:"pointing, directional gesture, indicating"},{keywords:["抱きしめ","ぎゅっ","ハグ"],name:"抱擁",prompt:"hugging, embracing, affectionate gesture"},{keywords:["手をひら","ストップ","待って"],name:"制止",prompt:"stop gesture, hand raised, halt motion"}])if(t.keywords.some(t=>e.includes(t)))return t;return{name:"自然",prompt:"natural facial expression, relaxed features"}}static buildEnhancedPrompt(e,t,r,o,n){let s=this.getTimeBasedLighting(),i=this.getSeasonalEnvironment();return[e,t.prompt,n.prompt,o.prompt,r.prompt,s,i,"masterpiece, best quality, highly detailed, beautiful lighting, anime style, high resolution, 8k, perfect anatomy, detailed face, expressive eyes"].filter(e=>e&&""!==e.trim()).join(", ")}static buildFinalPrompt(e,t,r){let o=this.getTimeBasedLighting(),n=this.getSeasonalEnvironment();return`${e}, ${t.prompt}, ${r.prompt}, ${o}, ${n}, masterpiece, best quality, highly detailed, beautiful lighting, anime style, high resolution, 8k`}static buildNegativePrompt(){return"lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry, bad face, ugly, duplicate, morbid, mutilated, extra fingers, mutated hands, poorly drawn hands, poorly drawn face, mutation, deformed, bad proportions, extra limbs, cloned face, disfigured, gross proportions, malformed limbs, missing arms, missing legs, extra arms, extra legs, fused fingers, too many fingers"}static getTimeBasedLighting(){let e=new Date().getHours();return e>=6&&e<12?"morning light, soft sunlight, bright atmosphere":e>=12&&e<17?"afternoon light, warm sunlight, clear lighting":e>=17&&e<20?"evening light, golden hour, warm atmosphere":"night lighting, soft artificial light, cozy atmosphere"}static getSeasonalEnvironment(){let e=new Date().getMonth()+1;return e>=3&&e<=5?"spring atmosphere, cherry blossoms, fresh green":e>=6&&e<=8?"summer atmosphere, bright sunshine, vivid colors":e>=9&&e<=11?"autumn atmosphere, fallen leaves, warm colors":"winter atmosphere, snow, cool lighting"}}let m="http://127.0.0.1:7860";async function l(e){try{let{aiResponse:t,character:r,conversationContext:o,loraSettings:n,seed:s}=await e.json(),i=p.generateImagePrompt(r,t,o),l=i.prompt;n&&"string"==typeof n&&n.trim().length>0&&(l=`${n}, ${l}`),console.log("Generated prompt result:",{emotion:i.emotion,scenario:i.scenario,prompt:i.prompt.substring(0,100)+"..."});let{imageWidth:g=512,imageHeight:d=768,imageSteps:u=28,imageCfgScale:c=8,imageSampler:h="DPM++ 2M Karras"}=r??{},y={prompt:l,_prompt:i.negativePrompt,width:g,height:d,steps:u,cfg_scale:c,seed:"number"==typeof s&&s>=0?s:Math.floor(0x100000000*Math.random()),sampler_name:h,batch_size:1,n_iter:1};console.log("Sending request to Stable Diffusion:",m);let f=await fetch(`${m}/sdapi/v1/txt2img`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});if(!f.ok)throw Error(`Stable Diffusion API error: ${f.status}`);let w=await f.json();if(w.images&&w.images.length>0)return a.NextResponse.json({image:`data:image/png;base64,${w.images[0]}`,success:!0});throw Error("画像生成に失敗しました")}catch(e){return console.error("Image generation error:",e),a.NextResponse.json({image:"https://via.placeholder.com/512x768/4A90E2/FFFFFF?text=Image+Generation+Failed",success:!1,error:e instanceof Error?e.message:"画像生成でエラーが発生しました"})}}let g=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/generate-image/route",pathname:"/api/generate-image",filename:"route",bundlePath:"app/api/generate-image/route"},resolvedPagePath:"C:\\Users\\kohar\\Desktop\\新しいフォルダー\\ai-chat\\src\\app\\api\\generate-image\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:d,workUnitAsyncStorage:u,serverHooks:c}=g;function h(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:u})}},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[447,580],()=>r(2908));module.exports=o})();